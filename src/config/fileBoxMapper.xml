<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fileBoxMapper">

	<select id="getProjects" resultType="com.oopsw.model.ProjectVO">
		SELECT
		project_no AS
		projectNo,
		project_name AS projectName,
		client,
		description
		FROM projects
		WHERE del_date IS NULL
	</select>

<select id="searchFilesOrTask" parameterType="map" resultType="com.oopsw.model.SearchFileBoxVO">
<bind name="keyword" value="searchKeyword == null ? null : '%' + searchKeyword + '%'" />

(
    SELECT
        c.file_name    AS fileName,
        c.file_path    AS filePath,
        p.project_name AS projectName,
        t.task_name    AS taskName,
        t.task_no      AS taskNo,
        p.project_no   AS projectNo,
        c.in_date      AS inDate,
        e.name         AS writerName
    FROM comments c
    JOIN project_join pj ON c.project_join_no = pj.project_join_no
    JOIN employees e     ON pj.employee_id = e.employee_id
    JOIN tasks t         ON c.task_no = t.task_no
    JOIN projects p      ON t.project_no = p.project_no
    WHERE c.del_date IS NULL
      AND t.del_date IS NULL
      AND p.del_date IS NULL
      <if test="taskNo != null">
        AND t.task_no = #{taskNo} AND c.file_name IS NOT NULL
      </if>
      <if test="searchKeyword != null and searchKeyword != ''">
        AND c.file_name LIKE #{keyword}
      </if>
)
UNION ALL
(
    SELECT
        r.file_name    AS fileName,
        r.file_path    AS filePath,
        p.project_name AS projectName,
        t.task_name    AS taskName,
        t.task_no      AS taskNo,
        p.project_no   AS projectNo,
        r.in_date      AS inDate,
        e.name         AS writerName
    FROM replies r
    JOIN comments c2     ON r.comment_no = c2.comment_no
    JOIN project_join pj ON r.project_join_no = pj.project_join_no
    JOIN employees e     ON pj.employee_id = e.employee_id
    JOIN tasks t         ON c2.task_no = t.task_no
    JOIN projects p      ON t.project_no = p.project_no
    WHERE r.del_date IS NULL
      AND c2.del_date IS NULL
      AND t.del_date IS NULL
      AND p.del_date IS NULL
      <if test="taskNo != null">
        AND t.task_no = #{taskNo} AND r.file_name IS NOT NULL
      </if>
      <if test="searchKeyword != null and searchKeyword != ''">
        AND r.file_name LIKE #{keyword}
      </if>
)
</select>



	<select id="getProjectNameTaskFileCount" parameterType="int"
		resultType="com.oopsw.model.ProjectFileBoxVO">
		SELECT
		t.task_no AS taskNo,
		t.task_name AS taskName,
		COUNT(c.file_name) +
		COUNT(r.file_name) AS totalFileCount
		FROM tasks t
		JOIN comments c ON c.task_no = t.task_no
		JOIN replies r ON r.comment_no = c.comment_no AND r.file_name IS NOT NULL
		WHERE t.project_no = #{projectNo}
		GROUP BY t.task_no, t.task_name
		ORDER BY t.task_no
	</select>
</mapper>